# Step 4: Deploy to DigitalOcean
- name: Deploy to DigitalOcean
  run: |
    ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SSH_HOST }} << EOF
      # Rebuild and run container chatbotmain
      CONTAINER_ID=\$(sudo docker ps -q --filter "name=chatbotmain")
      if [ "\$CONTAINER_ID" ]; then
        echo "Stopping and removing container chatbotmain..."
        sudo docker stop \$CONTAINER_ID
        sudo docker rm \$CONTAINER_ID

        IMAGE_ID=\$(sudo docker images -q chatbotmain)
        if [ "\$IMAGE_ID" ]; then
          echo "Removing image chatbotmain..."
          sudo docker rmi -f \$IMAGE_ID
        fi
      fi

      echo "Rebuilding and running container chatbotmain..."
      cd aibotprototype/main_server/
      sudo docker build -t chatbotmain .
      sudo docker run -d -p 8000:8000 chatbotmain

      # Rebuild and run container chatbotprocess
      CONTAINER_ID=\$(sudo docker ps -q --filter "name=chatbotprocess")
      if [ "\$CONTAINER_ID" ]; then
        echo "Stopping and removing container chatbotprocess..."
        sudo docker stop \$CONTAINER_ID
        sudo docker rm \$CONTAINER_ID

        IMAGE_ID=\$(sudo docker images -q chatbotprocess)
        if [ "\$IMAGE_ID" ]; then
          echo "Removing image chatbotprocess..."
          sudo docker rmi -f \$IMAGE_ID
        fi
      fi

      echo "Rebuilding and running container chatbotprocess..."
      cd aibotprototype/processing_server
      sudo docker build -t chatbotprocess .
      sudo docker run -d -p 9000:9000 chatbotprocess
    EOF
